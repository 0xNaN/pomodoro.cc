- name: install packages
  apt: pkg={{ item }} state=latest
  sudo: yes
  with_items:
    - nginx
    - nodejs
    - npm

- name: create project directory
  file: path=/pomodoro.cc state=directory owner=ubuntu group=ubuntu mode=0755
  sudo: yes

- name: copy ssl
  copy: src=ssl dest=/pomodoro.cc/ directory_mode=yes owner=ubuntu group=ubuntu mode=0755
  sudo: yes

- name: copy app www
  copy: src=../../../app/www/ dest=/pomodoro.cc/app/www/ owner=ubuntu group=ubuntu mode=0755
  sudo: yes

- name: copy api
  synchronize:
    src=../../../api/
    dest="/pomodoro.cc/api/"
    rsync_opts=--exclude=.git,--exclude=node_modules,--exclude=etc
    recursive=yes
    delete=yes
  sudo: yes

- name: copy credentials
  copy: src=../../../credentials.json dest=/pomodoro.cc/ owner=ubuntu group=ubuntu mode=0755
  sudo: yes

- name: install api dependencies
  npm: path="/pomodoro.cc/api/"
  sudo: yes

- name: remove default nginx configuration
  file: path=/etc/nginx/sites-available/default state=absent
  sudo: yes
  notify: restart nginx

- name: configure main nginx proxy
  copy: src=proxy dest=/etc/nginx/sites-enabled/default group=www-data
  sudo: yes
  notify: restart nginx

- name: configure app
  copy: src=app dest=/etc/nginx/sites-enabled/app group=www-data
  sudo: yes
  notify: restart nginx

- name: Install unit file
  copy: src=api.service dest=/etc/systemd/system/api.service owner=root mode=755
  sudo: yes
  notify:
    - reload systemd
